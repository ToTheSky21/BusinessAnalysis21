---
title: 'Classification models : Logistic Regression'
author: R package build
date: '2021-07-15'
slug: classification-models-logistic-regression
categories:
  - Tidyverse
  - tidymodels
  - ggplot2
tags: []
---
## Summary of Data

    The data is related with direct marketing campaigns of a Portuguese banking institution. The marketing campaigns were based on phone calls. To identify whether a customer would subscribe the bank term deposit or not, most of the time more than one contact to the same customer was required. Now,the information of a customers age, job, marital, education, default, balance, housing, loan, contact along side the data of day, month, duration, campaign, previous days, previous, previous outcome are available.
   These characteristics are considered important features in determining if the client will subscribe a term deposit or not, but it was not certain how important are each of these features really are.
   Here, classification model will build with logistics regression to predict if the client will subscribe a term deposit or not. 
```{r packages, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(openintro)
library(ggridges)
```
## Data Analysis

The exploratory data analysis involved univariate, bivariate analysis with some other relevant basic analysis to know the data set shortly. Here, the response variable is, y, whether the term deposit was made or not.Here, is the preview of data set.
```{r echo = FALSE, message=FALSE, warning=FALSE}
library(openintro)
bank <- read.table("bank.csv", sep=";", header=T)
head(bank)
```
## Summary of response variable
```{r echo = FALSE, message=FALSE, warning=FALSE}
table(bank$y)
prop.table(table(bank$y))
```
Here, we see that only 521 customer was subscribed for the term deposit and 4000 customer was not subscribed where as the proportion is 0.115 and 0.885 respectively.
## Bivariate analysis

## Term deposit and Customers Age
```{r echo = FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
bank %>%
  ggplot(aes(x = age, fill = y)) +
  geom_bar(position = "fill") +
  labs(
    x = 'Age of a customer', 
    fill = "Term deposit", 
    y = NULL,
    title = 'Term deposit vs. Customers Age'
    ) +
  scale_fill_manual(values = c("#DEB4A0", "#CA235F")) +
  theme(axis.text.x = element_text(angle = 90)) 
```
Is is observed that, most of the customer subscribed with term deposit, was with higher aged.
## Term deposit and Marital status
```{r echo = FALSE, message=FALSE, warning=FALSE}
bank %>%
  ggplot(aes(x = marital, fill = y)) +
  geom_bar(position = "fill") +
  labs(
    x = 'Whether a customer is Divorced, Married or Single', 
    fill = "Term deposit", 
    y = NULL,
    title = 'Term deposit vs. Marital status'
    ) +
  scale_fill_manual(values = c("#DEB4A0", "#CA235F"))
```
It is seen here that, the Marital status did not effect significantly on subscribing term loan, still the customer with status Divorced and Single subscribed more than Married customers.
## Term deposit and Job
```{r echo = FALSE, message=FALSE, warning=FALSE}
bank %>%
  ggplot(aes(x = job, fill = y)) +
  geom_bar(position = "fill") +
  labs(
    x = 'Job', 
    fill = "Term deposit", 
    y = NULL,
    title = 'Term deposit vs. Job'
    ) +
  scale_fill_manual(values = c("#DEB4A0", "#CA235F")) +
  theme(axis.text.x = element_text(angle = 90)) 
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
bank$y <- ifelse(bank$y == "yes", 1, 0)
bank$y <- factor(bank$y, levels = c(0, 1))
```
## Logistic regression model building

Logistic regression works for a data that contain continuous and/or categorical predictor variables. One advantage of logistic regression is that it computes a prediction probability score of an event.And, for predicting if a customer will default on a loan or not, or subscribe for a new product or not in Banking sector, binary classification or logistic regression is an effective method.Logistic regression achieves this by taking the log odds of the event ln(P/1?P), where, P is the probability of event. So P always lies between 0 and 1 as shown below:
```{r echo = FALSE, message=FALSE, warning=FALSE}
d <- tibble(p = seq(0.001, 0.999, length.out = 1000)) %>%
  mutate(logit_p = log(p/(1-p)))
ggplot(d, aes(x = p, y = logit_p)) + 
  geom_line() + 
  xlim(0,1) + 
  ylab("logit(p)") +
  labs(title = "logit(p) vs. p")
```
## Training and Test data

To improve the accuracy of the model, the following steps are taken, at first, the data is spitted randomly into training set (70% for building a predictive model) and test set (30% for evaluating the model) after removing potential outliers from the data set.The customer subscribed ‘yes’ and ‘no’ are split approximately in 1:8 ratio, as shown above.So, before building the logit model, we need to build the samples such that both the 1’s and 0’s are in approximately equal proportions.

## Balancing the classes of response variable

The customer subscribed for the term loan as "yes" and "no" in the data set are now divided in the same ratio as follows:
```{r echo = FALSE, message=FALSE, warning=FALSE}

set.seed(100)
#bank %>% drop_na(bank)
bank$y <- as.factor(bank$y)
#splitting
bank_split <- initial_split(bank, prop = 0.70, strata=y)

bank_train <- training(bank_split)
bank_test  <- testing(bank_split)
#head(testData)
head(bank)
```
## Balancing the classes of response variable

The customer subscribed for the term loan as "yes" and "no" in the data set are now divided in the same ratio as follows:

## Model with age, job, default and loan
```{r echo = FALSE, message=FALSE, warning=FALSE}
logitmod1 <- glm(y ~ age + job + default + loan , family = "binomial", data=bank_train)
logitmod1
```
## Model with all dependent variable
```{r echo = FALSE, message=FALSE, warning=FALSE}
logitmod2 <- glm(y ~ . , family = "binomial", data=bank_train)
summary(logitmod2)
```
## Model with contact, duration and poutcome
```{r echo = FALSE, message=FALSE, warning=FALSE}
logitmod3 <- glm(y ~ contact + duration + poutcome , family = "binomial", data=bank_train)
summary(logitmod3)
```
The logit models are now built.Comparing above models in terms of null and residual deviance, we find for that the logitmodel3 gives the best result. As, we know,the smaller the AIC, the better the model fits the data.Also, in comparison of null and residual deviance, the above model gives best result.

## Predict the response 
Now to predict the response on testData we will calculate the the prediction probabilities that the observation is yes for each observation.Let us compute the accuracy, which is nothing but the proportion of y_pred that matches with y_act, calculated below:
```{r echo = FALSE, message=FALSE, warning=FALSE}
pred <- predict(logitmod2, newdata = bank_test, type = "response")
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
y_pred_num <- ifelse(pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- bank_test$y
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
mean(y_pred == y_act)
```
Here, we have an accuracy rate of 80%.As we know. The common practice is to take the probability cutoff as 0.5. If the probability of Y is > 0.5, then it can be classified an event (subscribe).Here, 80% of the Y values belong to "Yes" and 20% belong to "No" class for the customer subscribed to term deposit. 

## Summary of variables:
```{r echo = FALSE, message=FALSE, warning=FALSE}
#bank$age <- as.factor(bank$age)
bank$job <- as.factor(bank$job)
bank$marital <- as.factor(bank$marital)
bank$education <- as.factor(bank$education)
bank$default <- as.factor(bank$default)
#bank$balance <- as.factor(bank$balance)
bank$housing <- as.factor(bank$housing)
bank$loan <- as.factor(bank$loan)
bank$contact <- as.factor(bank$contact)
bank$day <- as.factor(bank$day)
bank$month <- as.factor(bank$month)
bank$duration<- as.factor(bank$duration)
bank$campaign <- as.factor(bank$campaign)
bank$pdays <- as.factor(bank$pdays)
bank$previous <- as.factor(bank$previous)
bank$poutcome <- as.factor(bank$poutcome)
#summary(bank)
head(bank)
```
## Summary of findings:

* From the above model, that best fit the bank data, we can say that, though the model does not gives 100% accuracy, still the result is significantly high as we took the equal number or yes and no(balanced class) data as train data.

* To identify whether the customer will subscribe to the term deposit or not, we need to test with the above best fitted model for each new customer.

* The feature of some jobs, education, day, month, loan, previous outcome etc shown as significant variable to consider as gives higher p-values(>0.5).

* The effect of duration is significantly low in this model. 